<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Laporan Absensi Pegawai Bawaslu Riau</title>
    <!-- Tailwind CSS for modern styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts for a clean look -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #f97316;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #ea580c;
        }
        /* Style for date input placeholder */
        input[type="date"]:required:invalid::-webkit-datetime-edit {
            color: transparent;
        }
        input[type="date"]:focus::-webkit-datetime-edit {
            color: black !important;
        }
        
        /* CSS for Animated Checkmark */
        .animated-checkmark-icon path {
            stroke: #4CAF50; /* Green color for success */
            stroke-width: 6;
            stroke-linecap: round;
            stroke-linejoin: round;
            stroke-dasharray: 1000;
            stroke-dashoffset: 1000;
            animation: draw-checkmark 0.7s ease-out forwards;
        }

        @keyframes draw-checkmark {
            to {
                stroke-dashoffset: 0;
            }
        }
    </style>
</head>
<body class="bg-gray-100 antialiased">

    <!-- Header Section -->
    <header class="bg-gradient-to-r from-orange-500 to-orange-600 text-white shadow-lg sticky top-0 z-50">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
            <div>
                <h1 class="text-xl sm:text-2xl font-bold tracking-tight">Aplikasi Laporan Absensi Pegawai</h1>
                <p class="text-sm sm:text-md text-orange-100">Badan Pengawas Pemilihan Umum Provinsi Riau</p>
            </div>
            <div id="clock" class="text-lg font-semibold bg-white bg-opacity-20 px-4 py-2 rounded-lg shadow-inner">
                00:00:00
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="max-w-3xl mx-auto bg-white p-6 sm:p-8 rounded-2xl shadow-lg">
            <form id="absensiForm" class="space-y-6">
                <!-- Nama Pegawai Dropdown -->
                <div>
                    <label for="namaPegawai" class="block text-sm font-medium text-gray-700 mb-1">Nama Pegawai</label>
                    <select id="namaPegawai" name="namaPegawai" required class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-orange-500 focus:border-orange-500 transition duration-150 ease-in-out">
                        <option value="" disabled selected>-- Pilih Nama Pegawai --</option>
                        <option value="ASMIN SAFARI LUBIS">ASMIN SAFARI LUBIS</option>
                        <option value="TARMIZI">TARMIZI</option>
                        <option value="DONA DONORA">DONA DONORA</option>
                        <option value="GUSHENDRI">GUSHENDRI</option>
                        <option value="RIZKI KURNIAWAN">RIZKI KURNIAWAN</option>
                        <option value="ELVINA ARMISTA">ELVINA ARMISTA</option>
                        <option value="ASMED EFENDI">ASMED EFENDI</option>
                        <option value="VITRA AULIYA">VITRA AULIYA</option>
                        <option value="ANGGA PRATAMA">ANGGA PRATAMA</option>
                        <option value="ARYAN RIADI">ARYAN RIADI</option>
                        <option value="SRI REZEKI KHARIANTI">SRI REZEKI KHARIANTI</option>
                        <option value="LIZA APRIANA">LIZA APRIANA</option>
                        <option value="SULAIMAN FAKHRUR RAZI">SULAIMAN FAKHRUR RAZI</option>
                        <option value="TAMARA ARINDITA">TAMARA ARINDITA</option>
                        <option value="MUHAMMAD HASANUL ASY'ARY">MUHAMMAD HASANUL ASY'ARY</option>
                        <option value="LAODE MUHAMMAD AULIA">LAODE MUHAMMAD AULIA</option>
                        <option value="RESSY PUSPITA SARI">RESSY PUSPITA SARI</option>
                        <option value="MUTIARA FRITCILLA PANJAIATAN">MUTIARA FRITCILLA PANJAIATAN</option>
                        <option value="JEKI LEONAR ANDIKA TAMPU BOLON">JEKI LEONAR ANDIKA TAMPU BOLON</option>
                        <option value="ERMALIZHA PUTERI">ERMALIZHA PUTERI</option>
                        <option value="AZIZUL HAKIM">AZIZUL HAKIM</option>
                        <option value="BARITO GRINCA PAHALA SILALAHI">BARITO GRINCA PAHALA SILALAHI</option>
                        <option value="RAHMANESA">RAHMANESA</option>
                        <option value="HABIBULLAH">HABIBULLAH</option>
                        <option value="RIKI PRAYOGI">RIKI PRAYOGI</option>
                        <option value="ROZA FITRI YANI">ROZA FITRI YANI</option>
                        <option value="ERWINDU BUDI DARMA">ERWINDU BUDI DARMA</option>
                        <option value="ARI AGUNG PRAYITNO">ARI AGUNG PRAYITNO</option>
                        <option value="ARDIANSYAH EKA SAKTI">ARDIANSYAH EKA SAKTI</option>
                        <option value="MARCO ALFINDO MILLA JUNIOR">MARCO ALFINDO MILLA JUNIOR</option>
                        <option value="ISNITA AULIA SAFITRI">ISNITA AULIA SAFITRI</option>
                        <option value="T. AYUDEA RAHMADHANI">T. AYUDEA RAHMADHANI</option>
                        <option value="FITRI RAHMADANI">FITRI RAHMADANI</option>
                        <option value="RACHMATUL AZMI">RACHMATUL AZMI</option>
                        <option value="IRHAM">IRHAM</option>
                        <option value="M. HAMIDI MAIZA">M. HAMIDI MAIZA</option>
                        <option value="WILSON SAPUTRA">WILSON SAPUTRA</option>
                        <option value="RIRIN SULPIANI">RIRIN SULPIANI</option>
                        <option value="DARUSSALIM">DARUSSALIM</option>
                        <option value="NOVI SULASTRI">NOVI SULASTRI</option>
                        <option value="NUR ASIAH">NUR ASIAH</option>
                        <option value="NURHUDA SYAH">NURHUDA SYAH</option>
                        <option value="PUTRI WULAN SARI">PUTRI WULAN SARI</option>
                        <option value="RIDUWAN SAPUTRA">RIDUWAN SAPUTRA</option>
                        <option value="VERI HIDAYAT">VERI HIDAYAT</option>
                        <option value="ZULKARNAIN NASUTION">ZULKARNAIN NASUTION</option>
                        <option value="HERSYA NOGRAHA PRAMASWARI">HERSYA NOGRAHA PRAMASWARI</option>
                        <option value="ZUHRI">ZUHRI</option>
                        <option value="ARI SETIAWAN">ARI SETIAWAN</option>
                        <option value="EKA PUTRI HERMAYANI TANUWIJAYA">EKA PUTRI HERMAYANI TANUWIJAYA</option>
                        <option value="NASRUN RITONGA">NASRUN RITONGA</option>
                        <option value="HENDRIANTO HERMAWAN">HENDRIANTO HERMAWAN</option>
                        <option value="FERI SUSANDRA">FERI SUSANDRA</option>
                        <option value="ALFIN RESKI">ALFIN RESKI</option>
                        <option value="YANIS PRIMA">YANIS PRIMA</option>
                        <option value="SONI DARMUJIANTO">SONI DARMUJIANTO</option>
                        <option value="DANDI KURNIAWAN">DANDI KURNIAWAN</option>
                        <option value="JEFRI">JEFRI</option>
                        <option value="ANDRI ALI SAPUTRA">ANDRI ALI SAPUTRA</option>
                    </select>
                </div>

                <!-- Presensi Absensi Dropdown -->
                <div>
                    <label for="presensiAbsensi" class="block text-sm font-medium text-gray-700 mb-1">Presensi Absensi</label>
                    <select id="presensiAbsensi" name="presensiAbsensi" required class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-orange-500 focus:border-orange-500 transition duration-150 ease-in-out">
                        <option value="" disabled selected>-- Pilih Jenis Presensi --</option>
                        <option value="terlambat_pulang_awal">Hadir Terlambat/Pulang Lebih Awal</option>
                        <option value="izin">Izin Tidak Hadir</option>
                        <option value="kendala_mesin">Kendala Mesin Absensi</option>
                        <option value="dinas_luar">Dinas Luar</option>
                        <option value="wfa">WFA (Work From Anywhere)</option>
                    </select>
                </div>

                <!-- Dynamic Fields Container -->
                <div id="dynamic-fields" class="space-y-6">
                    <!-- Hadir Terlambat / Pulang Lebih Awal -->
                    <div id="terlambat_pulang_awal-fields" class="hidden p-4 border border-gray-200 rounded-lg space-y-4">
                        <h3 class="text-lg font-semibold text-gray-800 border-b pb-2">Keterangan Terlambat / Pulang Awal</h3>
                        <div>
                            <label for="terlambat_keterangan" class="block text-sm font-medium text-gray-700 mb-1">Keterangan</label>
                            <textarea id="terlambat_keterangan" name="terlambat_keterangan" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-orange-500 focus:border-orange-500"></textarea>
                        </div>
                        <div>
                            <label for="terlambat_tanggal" class="block text-sm font-medium text-gray-700 mb-1">Tanggal</label>
                            <input type="date" id="terlambat_tanggal" name="terlambat_tanggal" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-orange-500 focus:border-orange-500">
                        </div>
                        <div>
                            <label for="terlambat_dokumen" class="block text-sm font-medium text-gray-700 mb-1">Upload Dokumen Pendukung (Opsional)</label>
                            <input type="file" id="terlambat_dokumen" name="terlambat_dokumen" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-orange-50 file:text-orange-700 hover:file:bg-orange-100">
                        </div>
                    </div>

                    <!-- Kendala Mesin Absensi -->
                    <div id="kendala_mesin-fields" class="hidden p-4 border border-gray-200 rounded-lg space-y-4">
                        <h3 class="text-lg font-semibold text-gray-800 border-b pb-2">Laporan Kendala Mesin Absensi</h3>
                         <div>
                            <label for="kendala_deskripsi" class="block text-sm font-medium text-gray-700 mb-1">Deskripsi Kendala</label>
                            <textarea id="kendala_deskripsi" name="kendala_deskripsi" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-orange-500 focus:border-orange-500"></textarea>
                        </div>
                        <div>
                            <label for="kendala_tanggal" class="block text-sm font-medium text-gray-700 mb-1">Tanggal Kendala</label>
                            <input type="date" id="kendala_tanggal" name="kendala_tanggal" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-orange-500 focus:border-orange-500">
                        </div>
                        <div>
                            <label for="kendala_dokumen" class="block text-sm font-medium text-gray-700 mb-1">Upload Bukti (Foto/Video)</label>
                            <input type="file" id="kendala_dokumen" name="kendala_dokumen" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-orange-50 file:text-orange-700 hover:file:bg-orange-100">
                        </div>
                    </div>

                    <!-- WFA -->
                    <div id="wfa-fields" class="hidden p-4 border border-gray-200 rounded-lg space-y-4">
                        <h3 class="text-lg font-semibold text-gray-800 border-b pb-2">Laporan WFA</h3>
                        <div>
                             <label for="wfa_jenis" class="block text-sm font-medium text-gray-700 mb-1">Jenis Laporan WFA</label>
                            <select id="wfa_jenis" name="wfa_jenis" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-orange-500 focus:border-orange-500">
                                <option value="" disabled selected>-- Pilih Jenis Absensi --</option>
                                <option value="Masuk">Absensi Masuk</option>
                                <option value="Pulang">Absensi Pulang</option>
                            </select>
                        </div>
                        <div id="wfa-masuk-fields" class="hidden space-y-4">
                             <div>
                                <label for="wfa_rencana_kerja" class="block text-sm font-medium text-gray-700 mb-1">Rencana Kerja Hari Ini</label>
                                <textarea id="wfa_rencana_kerja" name="wfa_rencana_kerja" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-orange-500 focus:border-orange-500"></textarea>
                            </div>
                        </div>
                         <div id="wfa-pulang-fields" class="hidden space-y-4">
                             <div>
                                <label for="wfa_pencapaian_kerja" class="block text-sm font-medium text-gray-700 mb-1">Pencapaian Target Kerja Hari Ini</label>
                                <textarea id="wfa_pencapaian_kerja" name="wfa_pencapaian_kerja" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-orange-500 focus:border-orange-500"></textarea>
                            </div>
                        </div>
                        <div>
                            <label for="wfa_tanggal" class="block text-sm font-medium text-gray-700 mb-1">Tanggal WFA</label>
                            <input type="date" id="wfa_tanggal" name="wfa_tanggal" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-orange-500 focus:border-orange-500">
                        </div>
                    </div>

                    <!-- Dinas Luar -->
                    <div id="dinas_luar-fields" class="hidden p-4 border border-gray-200 rounded-lg space-y-4">
                        <h3 class="text-lg font-semibold text-gray-800 border-b pb-2">Laporan Dinas Luar</h3>
                        <div>
                            <label for="dinas_kota_tujuan" class="block text-sm font-medium text-gray-700 mb-1">Kota Tujuan</label>
                            <input type="text" id="dinas_kota_tujuan" name="dinas_kota_tujuan" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-orange-500 focus:border-orange-500">
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="dinas_tanggal_pergi" class="block text-sm font-medium text-gray-700 mb-1">Tanggal Pergi</label>
                                <input type="date" id="dinas_tanggal_pergi" name="dinas_tanggal_pergi" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-orange-500 focus:border-orange-500">
                            </div>
                            <div>
                                <label for="dinas_tanggal_pulang" class="block text-sm font-medium text-gray-700 mb-1">Tanggal Pulang</label>
                                <input type="date" id="dinas_tanggal_pulang" name="dinas_tanggal_pulang" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-orange-500 focus:border-orange-500">
                            </div>
                        </div>
                        <div>
                             <label for="dinas_jumlah_hari" class="block text-sm font-medium text-gray-700 mb-1">Jumlah Hari</label>
                            <input type="text" id="dinas_jumlah_hari" name="dinas_jumlah_hari" readonly class="w-full px-3 py-2 bg-gray-100 border border-gray-300 rounded-md shadow-sm">
                        </div>
                        <div>
                            <label for="dinas_dokumen" class="block text-sm font-medium text-gray-700 mb-1">Upload Surat Tugas</label>
                            <input type="file" id="dinas_dokumen" name="dinas_dokumen" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-orange-50 file:text-orange-700 hover:file:bg-orange-100">
                        </div>
                    </div>
                    
                    <!-- Izin -->
                     <div id="izin-fields" class="hidden p-4 border border-gray-200 rounded-lg space-y-4">
                        <h3 class="text-lg font-semibold text-gray-800 border-b pb-2">Form Izin Tidak Hadir</h3>
                         <div>
                            <label for="izin_perihal" class="block text-sm font-medium text-gray-700 mb-1">Perihal Izin</label>
                            <input type="text" id="izin_perihal" name="izin_perihal" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-orange-500 focus:border-orange-500">
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="izin_tanggal_awal" class="block text-sm font-medium text-gray-700 mb-1">Tanggal Awal Izin</label>
                                <input type="date" id="izin_tanggal_awal" name="izin_tanggal_awal" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-orange-500 focus:border-orange-500">
                            </div>
                            <div>
                                <label for="izin_tanggal_akhir" class="block text-sm font-medium text-gray-700 mb-1">Tanggal Akhir Izin</label>
                                <input type="date" id="izin_tanggal_akhir" name="izin_tanggal_akhir" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-orange-500 focus:border-orange-500">
                            </div>
                        </div>
                        <div>
                             <label for="izin_jumlah_hari" class="block text-sm font-medium text-gray-700 mb-1">Jumlah Hari Kerja</label>
                            <input type="text" id="izin_jumlah_hari" name="izin_jumlah_hari" readonly class="w-full px-3 py-2 bg-gray-100 border border-gray-300 rounded-md shadow-sm">
                        </div>
                        <div>
                            <label for="izin_dokumen" class="block text-sm font-medium text-gray-700 mb-1">Upload Surat Izin/Dokter</label>
                            <input type="file" id="izin_dokumen" name="izin_dokumen" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-orange-50 file:text-orange-700 hover:file:bg-orange-100">
                        </div>
                    </div>

                </div>

                <!-- Submit Button -->
                <div class="pt-4 border-t">
                    <button type="submit" id="submitBtn" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-base font-medium text-white bg-orange-600 hover:bg-orange-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-orange-500 transition-transform transform hover:scale-105">
                        <svg id="submit-icon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                        </svg>
                        <svg id="loading-spinner" class="hidden animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <span id="submit-text">Kirim Laporan</span>
                    </button>
                </div>
            </form>
        </div>
    </main>
    
    <!-- Notification Modal -->
    <div id="notificationModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <div id="modal-icon" class="mx-auto flex items-center justify-center h-20 w-20 mb-2">
                    <!-- Icon will be inserted by JavaScript -->
                </div>
                <h3 id="modal-title" class="text-lg leading-6 font-medium text-gray-900 mt-2">Berhasil!</h3>
                <div class="mt-2 px-7 py-3">
                    <p id="modal-message" class="text-sm text-gray-500"></p>
                </div>
                <div class="items-center px-4 py-3">
                    <button id="closeModal" class="px-4 py-2 bg-orange-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-orange-600 focus:outline-none focus:ring-2 focus:ring-orange-300">
                        OK
                    </button>
                </div>
            </div>
        </div>
    </div>


    <script>
    // --- IMPORTANT SETUP ---
    // Ganti URL ini dengan URL Web App dari Google Apps Script Anda.
    const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbx5XJha5tiNt8rA_4biwxsc2H-TfTnvvhSg7bXWscaCYEFXsZFzeqRQjrecCvMf09AQNw/exec';
    
    document.addEventListener('DOMContentLoaded', function () {
        // Clock Functionality
        const clockElement = document.getElementById('clock');
        setInterval(() => {
            const now = new Date();
            clockElement.textContent = now.toLocaleTimeString('id-ID', { hour12: false });
        }, 1000);

        // Form elements
        const form = document.getElementById('absensiForm');
        const presensiSelect = document.getElementById('presensiAbsensi');
        const dynamicFieldsContainer = document.getElementById('dynamic-fields');
        const allDynamicFields = dynamicFieldsContainer.querySelectorAll(':scope > div');

        // WFA specific elements
        const wfaJenisSelect = document.getElementById('wfa_jenis');
        const wfaMasukFields = document.getElementById('wfa-masuk-fields');
        const wfaPulangFields = document.getElementById('wfa-pulang-fields');

        // Date calculation elements
        const dinasPergi = document.getElementById('dinas_tanggal_pergi');
        const dinasPulang = document.getElementById('dinas_tanggal_pulang');
        const dinasJumlahHari = document.getElementById('dinas_jumlah_hari');
        const izinAwal = document.getElementById('izin_tanggal_awal');
        const izinAkhir = document.getElementById('izin_tanggal_akhir');
        const izinJumlahHari = document.getElementById('izin_jumlah_hari');

        // Modal elements
        const modal = document.getElementById('notificationModal');
        const closeModalBtn = document.getElementById('closeModal');
        
        // Submit button elements
        const submitBtn = document.getElementById('submitBtn');
        const submitText = document.getElementById('submit-text');
        const loadingSpinner = document.getElementById('loading-spinner');
        const submitIcon = document.getElementById('submit-icon');


        // Set minimum date for relevant inputs to today
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('kendala_tanggal').min = today;
        document.getElementById('wfa_tanggal').min = today;

        // Function to play a success sound
        function playSuccessSound() {
            try {
                const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                if (!audioCtx) return; // Web Audio API not supported
                
                const oscillator = audioCtx.createOscillator();
                const gainNode = audioCtx.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioCtx.destination);
                
                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(523.25, audioCtx.currentTime); // C5 note
                gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime); // Start with a gentle volume

                oscillator.start(audioCtx.currentTime);
                
                oscillator.frequency.setValueAtTime(783.99, audioCtx.currentTime + 0.1); // G5 note
                
                gainNode.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.4);
                oscillator.stop(audioCtx.currentTime + 0.5);
            } catch (e) {
                console.error("Could not play sound:", e);
            }
        }

        function showModal(title, message, isSuccess = true) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').innerHTML = message; // Use innerHTML to parse strong tag
            const iconContainer = document.getElementById('modal-icon');
            if (isSuccess) {
                playSuccessSound(); // Play sound on success
                iconContainer.className = 'mx-auto flex items-center justify-center h-20 w-20 mb-2';
                // PERBAIKAN: Menggunakan SVG animasi ceklis yang ringan dan pasti tampil.
                iconContainer.innerHTML = `<svg class="animated-checkmark-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" fill="none"><path d="M25 50 L45 70 L75 30"/></svg>`;
            } else {
                iconContainer.className = 'mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 mb-2';
                iconContainer.innerHTML = `<svg class="h-6 w-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`;
            }
            modal.style.display = 'block';
        }
        
        closeModalBtn.addEventListener('click', () => {
            modal.style.display = 'none';
        });

        // Function to show/hide fields based on selection
        function toggleDynamicFields() {
            const selectedValue = presensiSelect.value;
            allDynamicFields.forEach(field => {
                if (field.id === `${selectedValue}-fields`) {
                    field.classList.remove('hidden');
                    // Add 'required' to inputs within the visible section
                    field.querySelectorAll('input, select, textarea').forEach(input => {
                        // Skip optional fields like file uploads
                        if(input.type !== 'file') {
                             input.required = true;
                        }
                    });
                } else {
                    field.classList.add('hidden');
                    // Remove 'required' from inputs in hidden sections
                    field.querySelectorAll('input, select, textarea').forEach(input => {
                        input.required = false;
                    });
                }
            });
            // Reset WFA sub-fields specifically
            wfaMasukFields.classList.add('hidden');
            wfaPulangFields.classList.add('hidden');
            wfaMasukFields.querySelector('textarea').required = false;
            wfaPulangFields.querySelector('textarea').required = false;
             // Set file input for 'terlambat' as not required
            document.getElementById('terlambat_dokumen').required = false;
        }

        // Event listener for main dropdown
        presensiSelect.addEventListener('change', toggleDynamicFields);
        
        // Event listener for WFA dropdown
        wfaJenisSelect.addEventListener('change', function() {
            const selectedWfa = this.value;
            const rencanaKerja = wfaMasukFields.querySelector('textarea');
            const pencapaianKerja = wfaPulangFields.querySelector('textarea');
            
            wfaMasukFields.classList.add('hidden');
            rencanaKerja.required = false;
            wfaPulangFields.classList.add('hidden');
            pencapaianKerja.required = false;

            if(selectedWfa === 'Masuk') {
                wfaMasukFields.classList.remove('hidden');
                rencanaKerja.required = true;
            } else if (selectedWfa === 'Pulang') {
                wfaPulangFields.classList.remove('hidden');
                pencapaianKerja.required = true;
            }
        });

        // --- Date calculation logic ---
        
        // Menghitung hari kerja (Senin-Jumat)
        function calculateWorkDays(startDate, endDate, resultElement) {
            if (!startDate.value || !endDate.value) {
                resultElement.value = '';
                return;
            }

            let start = new Date(startDate.value);
            let end = new Date(endDate.value);

            if (end < start) {
                resultElement.value = '';
                return;
            }

            let workDays = 0;
            let currentDate = new Date(start);

            while (currentDate <= end) {
                const dayOfWeek = currentDate.getDay(); // 0 = Sunday, 6 = Saturday
                if (dayOfWeek !== 0 && dayOfWeek !== 6) {
                    workDays++;
                }
                currentDate.setDate(currentDate.getDate() + 1);
            }
            resultElement.value = `${workDays} hari`;
        }
        
        // Menghitung total hari (termasuk akhir pekan)
        function calculateTotalDays(startDate, endDate, resultElement) {
             if (!startDate.value || !endDate.value) {
                resultElement.value = '';
                return;
            }
            let start = new Date(startDate.value);
            let end = new Date(endDate.value);

            if (end < start) {
                resultElement.value = '';
                return;
            }
            
            const diffTime = Math.abs(end - start);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1; // Ditambah 1 agar inklusif
            resultElement.value = `${diffDays} hari`;
        }

        // Terapkan fungsi perhitungan yang sesuai
        dinasPergi.addEventListener('change', () => calculateTotalDays(dinasPergi, dinasPulang, dinasJumlahHari));
        dinasPulang.addEventListener('change', () => calculateTotalDays(dinasPergi, dinasPulang, dinasJumlahHari));
        izinAwal.addEventListener('change', () => calculateWorkDays(izinAwal, izinAkhir, izinJumlahHari));
        izinAkhir.addEventListener('change', () => calculateWorkDays(izinAwal, izinAkhir, izinJumlahHari));


        // Form Submission
        form.addEventListener('submit', function (e) {
            e.preventDefault();

            // Custom validation check
            let isValid = true;
            const requiredFields = form.querySelectorAll('[required]');
            requiredFields.forEach(field => {
                 let parent = field.closest('.p-4'); // Find the parent container
                 // Only check for validity if the field is inside a visible container
                 if (parent && !parent.classList.contains('hidden')) {
                     if (!field.value.trim()) {
                         isValid = false;
                     }
                 } else if (!parent && !field.value.trim()) { // For fields not in a dynamic container (like Nama Pegawai)
                    isValid = false;
                 }
            });

            if (!isValid) {
                showModal('Gagal', 'Harap lengkapi seluruh formulir yang wajib diisi.', false);
                return;
            }
            
            if (GOOGLE_SCRIPT_URL === 'PASTE_YOUR_GOOGLE_APPS_SCRIPT_URL_HERE' || GOOGLE_SCRIPT_URL === '') {
                showModal('Kesalahan Konfigurasi', 'URL Google Apps Script belum diatur. Silakan hubungi administrator.', false);
                return;
            }
            
            // Show loading state
            submitText.textContent = 'Mengirim...';
            loadingSpinner.classList.remove('hidden');
            submitIcon.classList.add('hidden');
            submitBtn.disabled = true;

            const selectedPresensiValue = presensiSelect.value;
            const selectedPresensiOption = presensiSelect.options[presensiSelect.selectedIndex];
            const presensiAbsensiText = selectedPresensiOption ? selectedPresensiOption.text : '';
            
            const fileInput = document.querySelector(`#${selectedPresensiValue}-fields input[type="file"]`);
            const file = fileInput ? fileInput.files[0] : null;

            const reader = new FileReader();

            const submitData = () => {
                const formData = new FormData(form);
                const dataObj = {
                    namaPegawai: formData.get('namaPegawai'),
                    presensiAbsensiText: presensiAbsensiText,
                    tanggalKejadian: '',
                    tanggalMulai: '',
                    tanggalSelesai: '',
                    jumlahHari: '',
                    kotaTujuan: '',
                    jenisWFA: '',
                    deskripsi: '',
                };

                // Kumpulkan data terperinci berdasarkan formulir yang terlihat
                switch (selectedPresensiValue) {
                    case 'terlambat_pulang_awal':
                        dataObj.deskripsi = formData.get('terlambat_keterangan');
                        dataObj.tanggalKejadian = formData.get('terlambat_tanggal');
                        dataObj.jumlahHari = '1 hari';
                        break;
                    case 'izin':
                        dataObj.deskripsi = formData.get('izin_perihal');
                        dataObj.tanggalMulai = formData.get('izin_tanggal_awal');
                        dataObj.tanggalSelesai = formData.get('izin_tanggal_akhir');
                        dataObj.jumlahHari = formData.get('izin_jumlah_hari');
                        break;
                    case 'kendala_mesin':
                        dataObj.deskripsi = formData.get('kendala_deskripsi');
                        dataObj.tanggalKejadian = formData.get('kendala_tanggal');
                        dataObj.jumlahHari = '1 hari';
                        break;
                    case 'dinas_luar':
                        dataObj.kotaTujuan = formData.get('dinas_kota_tujuan');
                        dataObj.tanggalMulai = formData.get('dinas_tanggal_pergi');
                        dataObj.tanggalSelesai = formData.get('dinas_tanggal_pulang');
                        dataObj.jumlahHari = formData.get('dinas_jumlah_hari');
                        dataObj.deskripsi = `Perjalanan Dinas ke ${dataObj.kotaTujuan}`;
                        break;
                    case 'wfa':
                        const wfaJenis = formData.get('wfa_jenis');
                        dataObj.jenisWFA = wfaJenis;
                        if (wfaJenis === 'Masuk') {
                            dataObj.deskripsi = formData.get('wfa_rencana_kerja');
                        } else if (wfaJenis === 'Pulang') {
                            dataObj.deskripsi = formData.get('wfa_pencapaian_kerja');
                        }
                        dataObj.tanggalKejadian = formData.get('wfa_tanggal');
                        break;
                }
                
                if (file) {
                    const today = new Date();
                    const dateString = `${today.getDate().toString().padStart(2, '0')}-${(today.getMonth() + 1).toString().padStart(2, '0')}-${today.getFullYear()}`;
                    const fileExtension = file.name.split('.').pop();
                    dataObj.fileName = `${dataObj.namaPegawai}_${dateString}.${fileExtension}`;
                    dataObj.fileType = file.type;
                    dataObj.fileData = reader.result;
                }

                fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors', // Penting untuk Web Apps agar tidak ada masalah CORS
                    cache: 'no-cache',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(dataObj)
                })
                .then(res => {
                    // Dengan no-cors, kita tidak bisa memeriksa respon, jadi kita asumsikan sukses
                    showModal('Berhasil!', `Laporan absensi atas nama <strong>${dataObj.namaPegawai}</strong> sudah diterima.`);
                    form.reset();
                    toggleDynamicFields();
                })
                .catch(error => {
                    showModal('Gagal', `Terjadi kesalahan saat mengirim data: ${error.message}`, false);
                })
                .finally(() => {
                    // Kembalikan tombol ke keadaan semula
                    submitText.textContent = 'Kirim Laporan';
                    loadingSpinner.classList.add('hidden');
                    submitIcon.classList.remove('hidden');
                    submitBtn.disabled = false;
                });
            };

            if (file) {
                reader.onload = submitData;
                reader.readAsDataURL(file);
            } else {
                submitData();
            }
        });
        
        // Inisialisasi tampilan form saat pertama kali dimuat
        toggleDynamicFields();
    });
    </script>

</body>
</html>

